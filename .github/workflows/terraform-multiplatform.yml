name: Terraform AWS Baseline

on:
  pull_request:
    branches: ["main"]
    paths:
      - ".github/workflows/terraform-multiplatform.yml"
      - "infra/terraform/**"
      - "docs/DEPLOY.md"
      - "README.md"
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - stg
          - prod
      action:
        description: "Run type"
        required: true
        default: "validate"
        type: choice
        options:
          - validate
          - plan
          - apply
      confirm_apply:
        description: "Type APPLY_AWS to run AWS apply"
        required: false
        default: ""
        type: string

permissions:
  contents: read

jobs:
  terraform-fmt:
    name: Terraform Fmt Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.11.1

      - name: Check formatting
        run: terraform fmt -check -recursive infra/terraform

  terraform-validate-aws:
    name: Terraform Validate (aws)
    runs-on: ubuntu-latest
    needs: terraform-fmt
    defaults:
      run:
        working-directory: infra/terraform/platforms/aws
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.11.1

      - name: Terraform init (no backend)
        run: terraform init -backend=false

      - name: Terraform validate
        run: terraform validate

  terraform-plan-aws:
    name: Terraform Plan (aws)
    runs-on: ubuntu-latest
    needs: terraform-validate-aws
    if: github.event_name == 'workflow_dispatch' && inputs.action == 'plan'
    permissions:
      contents: read
      id-token: write
    env:
      AWS_ROLE_TO_ASSUME: ${{ secrets.AWS_ROLE_TO_ASSUME }}
      TARGET_ENV: ${{ inputs.environment }}
    defaults:
      run:
        working-directory: infra/terraform/platforms/aws
    steps:
      - uses: actions/checkout@v4

      - name: Guard AWS secret
        run: |
          if [ -z "${AWS_ROLE_TO_ASSUME}" ]; then
            echo "::error::AWS_ROLE_TO_ASSUME is not configured."
            exit 1
          fi

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.11.1

      - name: Plan mode
        run: |
          if [ -z "${AWS_ROLE_TO_ASSUME}" ]; then
            echo "Running offline plan mode (no AWS OIDC secret configured)."
          else
            echo "Running OIDC-backed plan mode."
          fi

      - name: Configure AWS credentials (OIDC)
        if: env.AWS_ROLE_TO_ASSUME != ''
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ vars.AWS_REGION || 'ap-northeast-1' }}
          role-session-name: gha-terraform-plan-${{ inputs.environment }}

      - name: Terraform init (no backend)
        run: terraform init -backend=false

      - name: Terraform plan (aws baseline)
        run: |
          TFVARS="../../environments/${TARGET_ENV}/aws.tfvars"
          if [ ! -f "${TFVARS}" ]; then
            echo "::error::tfvars not found: ${TFVARS}"
            exit 1
          fi

          terraform plan \
            -refresh=false \
            -input=false \
            -lock=false \
            -var-file="${TFVARS}" \
            -out=tfplan

      - name: Upload plan artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-aws-${{ inputs.environment }}
          path: infra/terraform/platforms/aws/tfplan
          if-no-files-found: error

  terraform-apply-aws:
    name: Terraform Apply (aws)
    runs-on: ubuntu-latest
    needs: terraform-validate-aws
    if: github.event_name == 'workflow_dispatch' && inputs.action == 'apply'
    permissions:
      contents: read
      id-token: write
    env:
      AWS_ROLE_TO_ASSUME: ${{ secrets.AWS_ROLE_TO_ASSUME }}
      TARGET_ENV: ${{ inputs.environment }}
    defaults:
      run:
        working-directory: infra/terraform/platforms/aws
    steps:
      - uses: actions/checkout@v4

      - name: Guard confirm token
        run: |
          if [ "${{ inputs.confirm_apply }}" != "APPLY_AWS" ]; then
            echo "::error::confirm_apply must be APPLY_AWS for apply action."
            exit 1
          fi

      - name: Guard AWS secret
        run: |
          if [ -z "${AWS_ROLE_TO_ASSUME}" ]; then
            echo "::error::AWS_ROLE_TO_ASSUME is not configured."
            exit 1
          fi

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.11.1

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ vars.AWS_REGION || 'ap-northeast-1' }}
          role-session-name: gha-terraform-apply-${{ inputs.environment }}

      - name: Terraform init (no backend)
        run: terraform init -backend=false

      - name: Terraform apply (aws baseline)
        run: |
          TFVARS="../../environments/${TARGET_ENV}/aws.tfvars"
          if [ ! -f "${TFVARS}" ]; then
            echo "::error::tfvars not found: ${TFVARS}"
            exit 1
          fi
          terraform apply -auto-approve -input=false -lock=false -var-file="${TFVARS}"
