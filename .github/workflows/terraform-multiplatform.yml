name: Terraform Multi-Platform Skeleton

on:
  pull_request:
    branches: ["main"]
    paths:
      - ".github/workflows/terraform-multiplatform.yml"
      - "infra/terraform/**"
      - "docs/DEPLOY.md"
      - "README.md"
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - stg
          - prod
      action:
        description: "Run type"
        required: true
        default: "validate"
        type: choice
        options:
          - validate
          - plan
          - apply
      confirm_apply:
        description: "Type APPLY_AWS to run AWS apply"
        required: false
        default: ""
        type: string

permissions:
  contents: read
  id-token: write

jobs:
  terraform-fmt:
    name: Terraform Fmt Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.11.1

      - name: Check formatting
        run: terraform fmt -check -recursive infra/terraform

  terraform-validate:
    name: Terraform Validate (${{ matrix.platform }})
    runs-on: ubuntu-latest
    needs: terraform-fmt
    strategy:
      fail-fast: false
      matrix:
        platform: [aws, gcp, azure]

    defaults:
      run:
        working-directory: infra/terraform/platforms/${{ matrix.platform }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.11.1

      - name: Terraform init (no backend)
        run: terraform init -backend=false

      - name: Terraform validate
        run: terraform validate

  terraform-plan:
    name: Terraform Plan (${{ matrix.platform }})
    runs-on: ubuntu-latest
    needs: terraform-validate
    if: github.event_name == 'workflow_dispatch' && inputs.action == 'plan'
    env:
      AWS_ROLE_TO_ASSUME: ${{ secrets.AWS_ROLE_TO_ASSUME }}
      GCP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
      GCP_SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    strategy:
      fail-fast: false
      matrix:
        platform: [aws, gcp, azure]

    defaults:
      run:
        working-directory: infra/terraform/platforms/${{ matrix.platform }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.11.1

      - name: Configure AWS credentials (OIDC)
        if: matrix.platform == 'aws' && env.AWS_ROLE_TO_ASSUME != ''
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ vars.AWS_REGION || 'ap-northeast-1' }}
          role-session-name: gha-terraform-${{ inputs.environment }}

      - name: Warn when AWS OIDC secret is missing
        if: matrix.platform == 'aws' && env.AWS_ROLE_TO_ASSUME == ''
        run: |
          echo "::warning::AWS_ROLE_TO_ASSUME is not configured. AWS authenticated plan is skipped."
          exit 0

      #Node: Add per-cloud OIDC auth here before enabling real deploy/apply.
      - name: Configure GCP credentials (OIDC)
        if: matrix.platform == 'gcp' && env.GCP_WORKLOAD_IDENTITY_PROVIDER != '' && env.GCP_SERVICE_ACCOUNT != ''
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.GCP_SERVICE_ACCOUNT }}
          project_id: ${{ env.GCP_PROJECT_ID }}
          create_credentials_file: true
          export_environment_variables: true

      - name: Warn when GCP OIDC secrets are missing
        if: matrix.platform == 'gcp' && (env.GCP_WORKLOAD_IDENTITY_PROVIDER == '' || env.GCP_SERVICE_ACCOUNT == '')
        run: |
          echo "::warning::GCP_WORKLOAD_IDENTITY_PROVIDER / GCP_SERVICE_ACCOUNT is not configured. GCP authenticated plan is skipped."
          exit 0

      - name: Configure Azure credentials (OIDC)
        if: matrix.platform == 'azure' && env.AZURE_CLIENT_ID != '' && env.AZURE_TENANT_ID != '' && env.AZURE_SUBSCRIPTION_ID != ''
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}

      - name: Warn when Azure OIDC secrets are missing
        if: matrix.platform == 'azure' && (env.AZURE_CLIENT_ID == '' || env.AZURE_TENANT_ID == '' || env.AZURE_SUBSCRIPTION_ID == '')
        run: |
          echo "::warning::AZURE_CLIENT_ID / AZURE_TENANT_ID / AZURE_SUBSCRIPTION_ID is not configured. Azure authenticated plan is skipped."
          exit 0

      - name: Terraform init (no backend)
        if: |
          (matrix.platform == 'aws' && env.AWS_ROLE_TO_ASSUME != '') ||
          (matrix.platform == 'gcp' && env.GCP_WORKLOAD_IDENTITY_PROVIDER != '' && env.GCP_SERVICE_ACCOUNT != '') ||
          (matrix.platform == 'azure' && env.AZURE_CLIENT_ID != '' && env.AZURE_TENANT_ID != '' && env.AZURE_SUBSCRIPTION_ID != '')
        run: terraform init -backend=false

      - name: Terraform plan (skeleton)
        if: |
          (matrix.platform == 'aws' && env.AWS_ROLE_TO_ASSUME != '') ||
          (matrix.platform == 'gcp' && env.GCP_WORKLOAD_IDENTITY_PROVIDER != '' && env.GCP_SERVICE_ACCOUNT != '') ||
          (matrix.platform == 'azure' && env.AZURE_CLIENT_ID != '' && env.AZURE_TENANT_ID != '' && env.AZURE_SUBSCRIPTION_ID != '')
        env:
          TARGET_ENV: ${{ inputs.environment }}
        run: |
          TFVARS="../../environments/${TARGET_ENV}/${{ matrix.platform }}.tfvars"
          if [ ! -f "${TFVARS}" ]; then
            echo "::warning::tfvars not found: ${TFVARS}. skip plan."
            echo "#Node: create ${TARGET_ENV}/${{ matrix.platform }}.tfvars before enabling this plan."
            exit 0
          fi

          if [ "${{ matrix.platform }}" = "gcp" ] && grep -q 'replace-me' "${TFVARS}"; then
            echo "::warning::gcp.tfvars has placeholder project_id. skip plan."
            echo "#Node: set real project_id in ${TFVARS}."
            exit 0
          fi

          terraform plan \
            -refresh=false \
            -input=false \
            -lock=false \
            -var-file="${TFVARS}" \
            -out=tfplan

      - name: Upload plan artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ matrix.platform }}-${{ inputs.environment }}
          path: infra/terraform/platforms/${{ matrix.platform }}/tfplan
          if-no-files-found: ignore

  terraform-apply-aws:
    name: Terraform Apply (aws)
    runs-on: ubuntu-latest
    needs: terraform-validate
    if: github.event_name == 'workflow_dispatch' && inputs.action == 'apply'
    env:
      AWS_ROLE_TO_ASSUME: ${{ secrets.AWS_ROLE_TO_ASSUME }}
      TARGET_ENV: ${{ inputs.environment }}
    defaults:
      run:
        working-directory: infra/terraform/platforms/aws
    steps:
      - uses: actions/checkout@v4

      - name: Guard confirm token
        run: |
          if [ "${{ inputs.confirm_apply }}" != "APPLY_AWS" ]; then
            echo "::error::confirm_apply must be APPLY_AWS for apply action."
            exit 1
          fi

      - name: Guard AWS secret
        run: |
          if [ -z "${AWS_ROLE_TO_ASSUME}" ]; then
            echo "::error::AWS_ROLE_TO_ASSUME is not configured."
            exit 1
          fi

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.11.1

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ vars.AWS_REGION || 'ap-northeast-1' }}
          role-session-name: gha-terraform-apply-${{ inputs.environment }}

      - name: Terraform init (no backend)
        run: terraform init -backend=false

      - name: Terraform apply (aws skeleton)
        run: |
          TFVARS="../../environments/${TARGET_ENV}/aws.tfvars"
          if [ ! -f "${TFVARS}" ]; then
            echo "::error::tfvars not found: ${TFVARS}"
            exit 1
          fi
          terraform apply -auto-approve -input=false -lock=false -var-file="${TFVARS}"
