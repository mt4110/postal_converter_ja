name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  api:
    name: Rust API & Crawler Build / Test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # Rust toolchain
      - name: Install Rust
        uses: dtolnay/rust-toolchain@1.100.0
        with:
          components: rustfmt, clippy

      # ---- API ----
      - name: Cargo fmt (API)
        working-directory: worker/api
        run: cargo fmt -- --check

      - name: Cargo clippy (API)
        working-directory: worker/api
        run: cargo clippy --all-features --locked -- -D warnings

      - name: Cargo test (API)
        working-directory: worker/api
        run: cargo test --all-features --locked

      # ---- Crawler ----
      - name: Cargo fmt (Crawler)
        working-directory: worker/crawler
        run: cargo fmt -- --check

      - name: Cargo clippy (Crawler)
        working-directory: worker/crawler
        run: cargo clippy --all-features --locked -- -D warnings

      - name: Cargo test (Crawler)
        working-directory: worker/crawler
        run: cargo test --all-features --locked

  integration-db:
    name: DB Integration Test (MySQL + PostgreSQL)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@1.100.0
        with:
          components: rustfmt

      - name: Start Databases
        run: |
          mkdir -p storage/mysql/mysql_data storage/postgres/postgres_data
          docker compose up -d mysql postgres

      - name: Wait for Databases
        run: |
          for i in $(seq 1 60); do
            if docker exec mysql_container mysqladmin ping -uroot -pmysql_root --silent; then
              break
            fi
            sleep 2
          done
          docker exec mysql_container mysqladmin ping -uroot -pmysql_root --silent

          for i in $(seq 1 60); do
            if docker exec postgres_container pg_isready -U postgres -d zip_code_db; then
              break
            fi
            sleep 2
          done
          docker exec postgres_container pg_isready -U postgres -d zip_code_db

      - name: Run DB Integration Tests
        working-directory: worker
        env:
          MYSQL_DATABASE_URL: mysql://mysql_user:u_password@127.0.0.1:3204/zip_code_db
          POSTGRES_DATABASE_URL: postgres://postgres:postgres_password@127.0.0.1:3205/zip_code_db
        run: cargo test -p common --test db_integration --locked -- --nocapture --test-threads=1

      - name: Stop Databases
        if: always()
        run: docker compose down -v

  frontend:
    name: Frontend Lint
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Use Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          cd frontend
          yarn install --frozen-lockfile

      - name: Lint
        run: |
          cd frontend
          yarn lint

  launcher:
    name: Launcher Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24.10"

      - name: Build Launcher
        working-directory: launcher
        run: go build -v ./...

  helm:
    name: Helm Lint & Template
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Resolve Helm version
        id: helm-version
        run: echo "version=$(cat .github/versions/helm3.txt)" >> "$GITHUB_OUTPUT"

      - name: Resolve kubeconform version
        id: kubeconform-version
        run: echo "version=$(cat .github/versions/kubeconform.txt)" >> "$GITHUB_OUTPUT"

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ steps.helm-version.outputs.version }}

      - name: Install kubeconform
        run: |
          ARCH="$(uname -m)"
          case "$ARCH" in
            x86_64) ARCH="amd64" ;;
            aarch64|arm64) ARCH="arm64" ;;
            *) echo "Unsupported architecture: $ARCH"; exit 1 ;;
          esac
          curl -fsSL -o /tmp/kubeconform.tar.gz \
            "https://github.com/yannh/kubeconform/releases/download/${{ steps.kubeconform-version.outputs.version }}/kubeconform-linux-${ARCH}.tar.gz"
          tar -xzf /tmp/kubeconform.tar.gz -C /tmp kubeconform
          install -m 0755 /tmp/kubeconform /usr/local/bin/kubeconform
          kubeconform -v

      - name: Helm lint
        run: helm lint deploy/helm/postal-converter-ja

      - name: Helm template (default)
        run: |
          helm template postal-converter-ja deploy/helm/postal-converter-ja \
            --namespace postal-converter-ja \
            > /tmp/postal-converter-ja-default.yaml
          test -s /tmp/postal-converter-ja-default.yaml

      - name: Helm template (dev/stg/prod)
        run: |
          helm template postal-converter-ja deploy/helm/postal-converter-ja \
            --namespace postal-converter-ja-dev \
            -f deploy/helm/postal-converter-ja/values-dev.yaml \
            > /tmp/postal-converter-ja-dev.yaml
          helm template postal-converter-ja deploy/helm/postal-converter-ja \
            --namespace postal-converter-ja-stg \
            -f deploy/helm/postal-converter-ja/values-stg.yaml \
            > /tmp/postal-converter-ja-stg.yaml
          helm template postal-converter-ja deploy/helm/postal-converter-ja \
            --namespace postal-converter-ja-prod \
            -f deploy/helm/postal-converter-ja/values-prod.yaml \
            > /tmp/postal-converter-ja-prod.yaml
          test -s /tmp/postal-converter-ja-dev.yaml
          test -s /tmp/postal-converter-ja-stg.yaml
          test -s /tmp/postal-converter-ja-prod.yaml

      - name: kubeconform validate rendered manifests
        env:
          KUBECONFORM_ARGS: "-strict -summary -ignore-missing-schemas"
        run: |
          # CRD schema (e.g. ExternalSecret) may not be resolvable in CI network context.
          # Policy: keep strict validation for core resources and allow missing CRD schemas.
          for manifest in \
            /tmp/postal-converter-ja-default.yaml \
            /tmp/postal-converter-ja-dev.yaml \
            /tmp/postal-converter-ja-stg.yaml \
            /tmp/postal-converter-ja-prod.yaml; do
            kubeconform ${KUBECONFORM_ARGS} "$manifest"
          done
