# Runbook: DBロールバック対応 v0.9.0 (RNB-03)

最終更新: 2026-02-14 (JST)

## 1. 目的

データ更新またはリリース後に DB 不整合が発生した場合に、
ロールバック実施可否の判断から復旧確認までを標準化する。

## 2. 対象インシデント

- 更新後に検索結果が広範囲で不正
- DB migration/書き込み異常により API 品質が著しく悪化
- 直近データ反映が原因で事業影響が顕在化

## 3. 事前情報（開始時に記録）

- 検知時刻
- 対象環境 (`dev/stg/prod`)
- 影響範囲（機能、顧客、トラフィック）
- 直近変更（更新ジョブ、DB変更、アプリデプロイ）
- 直近バックアップ時刻 / 復元ポイント

## 4. ロールバック判断基準

以下を満たす場合にロールバックを検討:

- 5分平均 5xx が 3%以上、または主要検索が利用不能
- データ不整合が局所修正で解消できない
- 復旧見込みが 30 分以内に立たない

ロールバックを見送る条件:

- 影響が限定的で回避策が有効
- 再実行/部分修正で短時間復旧が見込める
- バックアップ整合性に疑義がある

## 5. 一次対応フロー（20分）

1. 健康状態と影響確認

```bash
curl -fsS https://<prod-host>/ready
kubectl -n postal-converter-ja-prod logs deploy/postal-converter-ja --tail=300
```

2. 直近変更の特定

- 更新ジョブ成功/失敗時刻
- 直近デプロイ時刻
- DB migration 実行履歴

3. 切り分け

- Secret/接続起因: `docs/EXTERNAL_SECRETS_RUNBOOK.md` へ分岐
- 更新起因: `docs/RUNBOOK_UPDATE_FAILURE_v0_9_0.md` を参照
- DBデータ起因: 本書 6章へ進む

## 6. DBロールバック実施手順

### 6.1 準備

1. 復元ポイント（スナップショット/バックアップ）を決定
2. 復元対象（DB全体/スキーマ/テーブル）を明確化
3. 影響通知（Incident チャンネル、関係者）

### 6.2 実施

実施手段は環境に依存するため、運用環境の標準手順に従う。

- マネージドDB: スナップショット復元またはポイントインタイム復元
- セルフホスト: バックアップから復元

注意:

- 復元中は追加更新を停止し、二重更新を防ぐ
- 復元後にアプリ接続情報が変わる場合は Secret を同期する

### 6.3 アプリ側整合

```bash
kubectl -n postal-converter-ja-prod rollout restart deploy/postal-converter-ja
kubectl -n postal-converter-ja-prod rollout status deploy/postal-converter-ja
curl -fsS https://<prod-host>/ready
```

## 7. 復旧判定

復旧完了は以下を満たすこと:

- `/ready` が安定して 2xx
- 代表検索クエリが期待値どおり
- 5xx / p95 が通常レンジへ復帰
- 更新ジョブ再開の可否を判断済み

## 8. エスカレーション基準

以下は P1:

- ロールバック判断後 20 分以内に実施開始できない
- 復元失敗または復元後も主要機能が利用不能

以下は P2:

- 復元完了したがデータ差分検証に追加時間が必要

## 9. 事後対応

- 障害タイムライン作成（検知/判断/実施/復旧）
- 根本原因と再発防止策を `v0.9.xxx` Issue 化
- バックアップ運用/更新手順に改善を反映

## 10. 人間テスト観点（QA-01連携）

- 初見担当者が 40 分以内にロールバック可否を判断できるか
- 復元ポイント選定の根拠を説明できるか
- 復旧判定を証跡付きで完了できるか
